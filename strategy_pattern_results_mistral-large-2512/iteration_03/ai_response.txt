File `ansitowin32.py`:
```python
import re
import sys
import os

from .ansi import AnsiFore, AnsiBack, AnsiStyle, Style, BEL
from .winterm import enable_vt_processing, WinTerm, WinColor, WinStyle
from .win32 import windll, winapi_test

winterm = None
if windll is not None:
    winterm = WinTerm()

class StreamWrapper:

    def __init__(self, wrapped, converter):
        self.__wrapped = wrapped
        self.__convertor = converter

    def __getattr__(self, name):
        return getattr(self.__wrapped, name)

    def __enter__(self, *args, **kwargs):
        return self.__wrapped.__enter__(*args, **kwargs)

    def __exit__(self, *args, **kwargs):
        return self.__wrapped.__exit__(*args, **kwargs)

    def __setstate__(self, state):
        self.__dict__ = state

    def __getstate__(self):
        return self.__dict__

    def write(self, text):
        self.__convertor.write(text)

    def isatty(self):
        stream = self.__wrapped
        if 'PYCHARM_HOSTED' in os.environ:
            if stream is not None and (stream is sys.__stdout__ or stream is sys.__stderr__):
                return True
        try:
            stream_isatty = stream.isatty
        except AttributeError:
            return False
        else:
            return stream_isatty()

    @property
    def closed(self):
        stream = self.__wrapped
        try:
            return stream.closed
        except (AttributeError, ValueError):
            return True

def _strategy_reset_all(params, on_stderr=False):
    winterm.reset_all(on_stderr=on_stderr)

def _strategy_style(params, on_stderr=False):
    style = params[0]
    if style == AnsiStyle.BRIGHT:
        winterm.style(WinStyle.BRIGHT, on_stderr=on_stderr)
    elif style == AnsiStyle.DIM:
        winterm.style(WinStyle.NORMAL, on_stderr=on_stderr)
    elif style == AnsiStyle.NORMAL:
        winterm.style(WinStyle.NORMAL, on_stderr=on_stderr)

def _strategy_fore(params, on_stderr=False):
    param = params[0]
    light = len(params) > 1 and params[1] == 1
    if param == AnsiFore.BLACK:
        winterm.fore(WinColor.BLACK, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.RED:
        winterm.fore(WinColor.RED, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.GREEN:
        winterm.fore(WinColor.GREEN, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.YELLOW:
        winterm.fore(WinColor.YELLOW, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.BLUE:
        winterm.fore(WinColor.BLUE, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.MAGENTA:
        winterm.fore(WinColor.MAGENTA, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.CYAN:
        winterm.fore(WinColor.CYAN, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.WHITE:
        winterm.fore(WinColor.GREY, light=light, on_stderr=on_stderr)
    elif param == AnsiFore.RESET:
        winterm.fore(on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTBLACK_EX:
        winterm.fore(WinColor.BLACK, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTRED_EX:
        winterm.fore(WinColor.RED, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTGREEN_EX:
        winterm.fore(WinColor.GREEN, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTYELLOW_EX:
        winterm.fore(WinColor.YELLOW, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTBLUE_EX:
        winterm.fore(WinColor.BLUE, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTMAGENTA_EX:
        winterm.fore(WinColor.MAGENTA, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTCYAN_EX:
        winterm.fore(WinColor.CYAN, light=True, on_stderr=on_stderr)
    elif param == AnsiFore.LIGHTWHITE_EX:
        winterm.fore(WinColor.GREY, light=True, on_stderr=on_stderr)

def _strategy_back(params, on_stderr=False):
    param = params[0]
    light = len(params) > 1 and params[1] == 1
    if param == AnsiBack.BLACK:
        winterm.back(WinColor.BLACK, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.RED:
        winterm.back(WinColor.RED, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.GREEN:
        winterm.back(WinColor.GREEN, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.YELLOW:
        winterm.back(WinColor.YELLOW, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.BLUE:
        winterm.back(WinColor.BLUE, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.MAGENTA:
        winterm.back(WinColor.MAGENTA, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.CYAN:
        winterm.back(WinColor.CYAN, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.WHITE:
        winterm.back(WinColor.GREY, light=light, on_stderr=on_stderr)
    elif param == AnsiBack.RESET:
        winterm.back(on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTBLACK_EX:
        winterm.back(WinColor.BLACK, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTRED_EX:
        winterm.back(WinColor.RED, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTGREEN_EX:
        winterm.back(WinColor.GREEN, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTYELLOW_EX:
        winterm.back(WinColor.YELLOW, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTBLUE_EX:
        winterm.back(WinColor.BLUE, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTMAGENTA_EX:
        winterm.back(WinColor.MAGENTA, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTCYAN_EX:
        winterm.back(WinColor.CYAN, light=True, on_stderr=on_stderr)
    elif param == AnsiBack.LIGHTWHITE_EX:
        winterm.back(WinColor.GREY, light=True, on_stderr=on_stderr)

def _strategy_erase_screen(params, on_stderr=False):
    mode = params[0] if params else 0
    winterm.erase_screen(mode, on_stderr=on_stderr)

def _strategy_erase_line(params, on_stderr=False):
    mode = params[0] if params else 0
    winterm.erase_line(mode, on_stderr=on_stderr)

def _strategy_set_cursor_position(params, on_stderr=False):
    position = params if len(params) >= 2 else (1, 1)
    winterm.set_cursor_position(position, on_stderr=on_stderr)

def _strategy_cursor_adjust(params, command, on_stderr=False):
    n = params[0] if params else 1
    adjustments = {'A': (0, -n), 'B': (0, n), 'C': (n, 0), 'D': (-n, 0)}
    x, y = adjustments[command]
    winterm.cursor_adjust(x, y, on_stderr=on_stderr)

COMMAND_STRATEGIES = {
    'm': _strategy_style,
    'J': _strategy_erase_screen,
    'K': _strategy_erase_line,
    'H': _strategy_set_cursor_position,
    'f': _strategy_set_cursor_position,
    'A': _strategy_cursor_adjust,
    'B': _strategy_cursor_adjust,
    'C': _strategy_cursor_adjust,
    'D': _strategy_cursor_adjust,
}

PARAM_STRATEGIES = {
    AnsiStyle.RESET_ALL: _strategy_reset_all,
    AnsiStyle.BRIGHT: _strategy_style,
    AnsiStyle.DIM: _strategy_style,
    AnsiStyle.NORMAL: _strategy_style,
    AnsiFore.BLACK: _strategy_fore,
    AnsiFore.RED: _strategy_fore,
    AnsiFore.GREEN: _strategy_fore,
    AnsiFore.YELLOW: _strategy_fore,
    AnsiFore.BLUE: _strategy_fore,
    AnsiFore.MAGENTA: _strategy_fore,
    AnsiFore.CYAN: _strategy_fore,
    AnsiFore.WHITE: _strategy_fore,
    AnsiFore.RESET: _strategy_fore,
    AnsiFore.LIGHTBLACK_EX: _strategy_fore,
    AnsiFore.LIGHTRED_EX: _strategy_fore,
    AnsiFore.LIGHTGREEN_EX: _strategy_fore,
    AnsiFore.LIGHTYELLOW_EX: _strategy_fore,
    AnsiFore.LIGHTBLUE_EX: _strategy_fore,
    AnsiFore.LIGHTMAGENTA_EX: _strategy_fore,
    AnsiFore.LIGHTCYAN_EX: _strategy_fore,
    AnsiFore.LIGHTWHITE_EX: _strategy_fore,
    AnsiBack.BLACK: _strategy_back,
    AnsiBack.RED: _strategy_back,
    AnsiBack.GREEN: _strategy_back,
    AnsiBack.YELLOW: _strategy_back,
    AnsiBack.BLUE: _strategy_back,
    AnsiBack.MAGENTA: _strategy_back,
    AnsiBack.CYAN: _strategy_back,
    AnsiBack.WHITE: _strategy_back,
    AnsiBack.RESET: _strategy_back,
    AnsiBack.LIGHTBLACK_EX: _strategy_back,
    AnsiBack.LIGHTRED_EX: _strategy_back,
    AnsiBack.LIGHTGREEN_EX: _strategy_back,
    AnsiBack.LIGHTYELLOW_EX: _strategy_back,
    AnsiBack.LIGHTBLUE_EX: _strategy_back,
    AnsiBack.LIGHTMAGENTA_EX: _strategy_back,
    AnsiBack.LIGHTCYAN_EX: _strategy_back,
    AnsiBack.LIGHTWHITE_EX: _strategy_back,
}

class AnsiToWin32:

    ANSI_CSI_RE = re.compile('\001?\033\\[((?:\\d|;)*)([a-zA-Z])\002?')
    ANSI_OSC_RE = re.compile('\001?\033\\]([^\a]*)(\a)\002?')

    def __init__(self, wrapped, convert=None, strip=None, autoreset=False):
        self.wrapped = wrapped

        self.autoreset = autoreset

        self.stream = StreamWrapper(wrapped, self)

        on_windows = os.name == 'nt'
        conversion_supported = on_windows and winapi_test()
        try:
            fd = wrapped.fileno()
        except Exception:
            fd = -1
        system_has_native_ansi = not on_windows or enable_vt_processing(fd)
        have_tty = not self.stream.closed and self.stream.isatty()
        need_conversion = conversion_supported and not system_has_native_ansi

        if strip is None:
            strip = need_conversion or not have_tty
        self.strip = strip

        if convert is None:
            convert = need_conversion and have_tty
        self.convert = convert

        self.on_stderr = self.wrapped is sys.stderr

    def should_wrap(self):
        return self.convert or self.strip or self.autoreset

    def write(self, text):
        if self.strip or self.convert:
            self.write_and_convert(text)
        else:
            self.wrapped.write(text)
            self.wrapped.flush()
        if self.autoreset:
            self.reset_all()

    def reset_all(self):
        if self.convert:
            self.call_win32('m', (0,))
        elif not self.strip and not self.stream.closed:
            self.wrapped.write(Style.RESET_ALL)

    def write_and_convert(self, text):
        cursor = 0
        text = self.convert_osc(text)
        for match in self.ANSI_CSI_RE.finditer(text):
            start, end = match.span()
            self.write_plain_text(text, cursor, start)
            self.convert_ansi(*match.groups())
            cursor = end
        self.write_plain_text(text, cursor, len(text))

    def write_plain_text(self, text, start, end):
        if start < end:
            self.wrapped.write(text[start:end])
            self.wrapped.flush()

    def convert_ansi(self, paramstring, command):
        if self.convert:
            params = self.extract_params(command, paramstring)
            self.call_win32(command, params)

    def extract_params(self, command, paramstring):
        if command in 'Hf':
            params = tuple(int(p) if len(p) != 0 else 1 for p in paramstring.split(';'))
            while len(params) < 2:
                params = params + (1,)
        else:
            params = tuple(int(p) for p in paramstring.split(';') if len(p) != 0)
            if len(params) == 0:
                if command in 'JKm':
                    params = (0,)
                elif command in 'ABCD':
                    params = (1,)

        return params

    def call_win32(self, command, params):
        if command in COMMAND_STRATEGIES:
            strategy = COMMAND_STRATEGIES[command]
            if command == 'm':
                for param in params:
                    if param in PARAM_STRATEGIES:
                        param_strategy = PARAM_STRATEGIES[param]
                        param_strategy(params, on_stderr=self.on_stderr)
                        break
            else:
                strategy(params, on_stderr=self.on_stderr)
        elif command in 'J':
            _strategy_erase_screen(params, on_stderr=self.on_stderr)
        elif command in 'K':
            _strategy_erase_line(params, on_stderr=self.on_stderr)
        elif command in 'Hf':
            _strategy_set_cursor_position(params, on_stderr=self.on_stderr)
        elif command in 'ABCD':
            _strategy_cursor_adjust(params, command, on_stderr=self.on_stderr)

    def convert_osc(self, text):
        for match in self.ANSI_OSC_RE.finditer(text):
            start, end = match.span()
            text = text[:start] + text[end:]
            paramstring, command = match.groups()
            if command == BEL:
                if paramstring.count(";") == 1:
                    params = paramstring.split(";")
                    if params[0] in '02':
                        winterm.set_title(params[1])
        return text

    def flush(self):
        self.wrapped.flush()
```